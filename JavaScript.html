<script>
/**
 * KUBOXT 配車プランナー - クライアントサイドロジック
 * モジュール: DataManager, GanttManager, UIManager
 */

// ステータス定数 (サーバーのCONFIG.STATUSと一致させる)
var STATUS = {
  UNASSIGNED: '未割当',
  ASSIGNED: '割当済',
  EN_ROUTE: '配送中',
  COMPLETED: '完了'
};

/* ========================================================
 * DataManager - データ管理 + Observer パターン
 * ======================================================== */
var DataManager = (function() {
  var orders = [];
  var vehicles = [];
  var observers = [];

  function subscribe(fn) {
    observers.push(fn);
  }

  function notifyObservers() {
    observers.forEach(function(fn) { fn(); });
  }

  function callServer(fnName) {
    var args = Array.prototype.slice.call(arguments, 1);
    return new Promise(function(resolve, reject) {
      var runner = google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject);
      runner[fnName].apply(runner, args);
    });
  }

  function loadData() {
    return callServer('getData').then(function(result) {
      if (!result.success) {
        throw new Error(result.error || 'データの取得に失敗しました。');
      }
      orders = result.orders || [];
      vehicles = result.vehicles || [];
      notifyObservers();
      return result;
    });
  }

  function getOrders() { return orders; }
  function getVehicles() { return vehicles; }

  function getUnassignedOrders() {
    return orders.filter(function(o) { return o.status === STATUS.UNASSIGNED || !o.status; });
  }

  function getAssignedOrders() {
    return orders.filter(function(o) { return o.status && o.status !== STATUS.UNASSIGNED; });
  }

  function getOrderById(requestId) {
    for (var i = 0; i < orders.length; i++) {
      if (orders[i].requestId === requestId) return orders[i];
    }
    return null;
  }

  /**
   * Optimistic更新: ローカルを即座に更新 → サーバー同期 → 失敗時ロールバック
   */
  function updateOrder(orderId, updates) {
    var order = getOrderById(orderId);
    if (!order) return Promise.reject(new Error('受注が見つかりません'));

    var snapshot = JSON.parse(JSON.stringify(order));

    // ローカル即時更新
    Object.keys(updates).forEach(function(key) {
      order[key] = updates[key];
    });

    // ナンバー変更時は車両マスターから自動反映
    if (updates.number) {
      var vehicle = getVehicleByNumber(updates.number);
      if (vehicle) {
        order.vehicleNumber = vehicle.vehicleNumber || '';
        order.vehicleType = vehicle.vehicleType;
        order.driverName = vehicle.driverName;
      }
    } else if (updates.number === '') {
      order.vehicleNumber = '';
      order.vehicleType = '';
      order.driverName = '';
    }

    notifyObservers();

    // サーバー同期
    return callServer('updateOrder', orderId, updates)
      .then(function(result) {
        if (result && !result.success) {
          throw new Error(result.error || '更新に失敗しました。');
        }
        return result;
      })
      .catch(function(err) {
        // ロールバック
        Object.keys(snapshot).forEach(function(key) {
          order[key] = snapshot[key];
        });
        notifyObservers();
        throw err;
      });
  }

  function getVehicleByNumber(number) {
    for (var i = 0; i < vehicles.length; i++) {
      if (vehicles[i].number === number) return vehicles[i];
    }
    return null;
  }

  return {
    loadData: loadData,
    getOrders: getOrders,
    getVehicles: getVehicles,
    getUnassignedOrders: getUnassignedOrders,
    getAssignedOrders: getAssignedOrders,
    getOrderById: getOrderById,
    getVehicleByNumber: getVehicleByNumber,
    updateOrder: updateOrder,
    subscribe: subscribe,
    callServer: callServer
  };
})();


/* ========================================================
 * DOM ヘルパー - 安全な要素生成 (innerHTML不使用)
 * ======================================================== */
var DOM = {
  el: function(tag, attrs, children) {
    var el = document.createElement(tag);
    if (attrs) {
      Object.keys(attrs).forEach(function(key) {
        if (key === 'className') {
          el.className = attrs[key];
        } else if (key === 'textContent') {
          el.textContent = attrs[key];
        } else if (key === 'style' && typeof attrs[key] === 'object') {
          Object.keys(attrs[key]).forEach(function(prop) {
            el.style[prop] = attrs[key][prop];
          });
        } else {
          el.setAttribute(key, attrs[key]);
        }
      });
    }
    if (children) {
      children.forEach(function(child) {
        if (typeof child === 'string') {
          el.appendChild(document.createTextNode(child));
        } else if (child) {
          el.appendChild(child);
        }
      });
    }
    return el;
  },
  clear: function(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }
};


/* ========================================================
 * GanttManager - Frappe Gantt 初期化 & イベント
 * ======================================================== */
var GanttManager = (function() {
  var gantt = null;
  var currentViewMode = 'Week';

  function getStatusClass(status) {
    switch (status) {
      case STATUS.ASSIGNED: return 'status-assigned';
      case STATUS.EN_ROUTE: return 'status-enroute';
      case STATUS.COMPLETED: return 'status-completed';
      default: return 'status-unassigned';
    }
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case STATUS.ASSIGNED: return 'assigned';
      case STATUS.EN_ROUTE: return 'enroute';
      case STATUS.COMPLETED: return 'completed';
      default: return 'unassigned';
    }
  }

  /**
   * YYYY-MM-DD形式の日付文字列かどうかを検証
   */
  function isValidDateStr(s) {
    return typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s);
  }

  function mapOrdersToGanttTasks(orders) {
    return orders
      .filter(function(order) {
        // 積込日が無い受注はガントに表示できない
        return isValidDateStr(order.loadDate);
      })
      .map(function(order) {
        var startDate = order.loadDate;
        var startTime = order.loadTime || '00:00';

        // 荷卸日が無い場合は積込日と同日とする
        var endDate = isValidDateStr(order.unloadDate) ? order.unloadDate : startDate;
        var endTime = order.unloadTime || '23:59';

        // 終了が開始より前の場合は同日に補正
        if (endDate < startDate) {
          endDate = startDate;
        }

        // 同日かつ終了時間が開始時間以前の場合は終了を+1時間に補正
        if (endDate === startDate && endTime <= startTime) {
          var parts = startTime.split(':');
          var h = (parseInt(parts[0], 10) + 1) % 24;
          endTime = ('0' + h).slice(-2) + ':' + parts[1];
        }

        // バー表示名: 割当済なら車番も表示
        var displayName = order.shipper + ' - ' + order.cargoName;
        if (order.vehicleNumber) {
          displayName = '[' + order.vehicleNumber + '] ' + displayName;
        }

        return {
          id: order.requestId,
          name: displayName,
          start: startDate + ' ' + startTime,
          end: endDate + ' ' + endTime,
          progress: order.status === STATUS.COMPLETED ? 100 : (order.status === STATUS.EN_ROUTE ? 50 : 0),
          custom_class: getStatusClass(order.status),
          dependencies: ''
        };
      });
  }

  /**
   * Frappe Ganttポップアップ用HTML (ライブラリAPIが文字列を要求)
   * 全動的値はescapeHtmlで無害化
   */
  function buildPopupHtml(task) {
    var order = DataManager.getOrderById(task.id);
    if (!order) return '';
    var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
    var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');
    var parts = [
      '<div class="p-2" style="min-width:220px">',
      '<h6 class="mb-1">', escapeHtml(order.shipper), '</h6>',
      '<p class="mb-1 small">', escapeHtml(order.cargoName), '</p>',
      '<p class="mb-1 small text-muted">',
        escapeHtml(loadLoc), ' → ', escapeHtml(unloadLoc),
      '</p>'
    ];
    if (order.driverName) {
      parts.push('<p class="mb-0 small"><strong>運転手:</strong> ', escapeHtml(order.driverName), '</p>');
    }
    if (order.vehicleNumber) {
      parts.push('<p class="mb-0 small"><strong>車番:</strong> ', escapeHtml(order.vehicleNumber), '</p>');
    }
    parts.push(
      '<span class="badge status-badge-', getStatusBadgeClass(order.status), '">',
      escapeHtml(order.status), '</span>',
      '</div>'
    );
    return parts.join('');
  }

  function init() {
    // 全受注をガントチャートに表示 (未割当=グレー, 割当済=青, 配送中=オレンジ, 完了=緑)
    var allOrders = DataManager.getOrders();
    var ganttEl = document.getElementById('gantt');
    var emptyEl = document.getElementById('ganttEmpty');

    var tasks = mapOrdersToGanttTasks(allOrders);

    if (tasks.length === 0) {
      ganttEl.style.display = 'none';
      emptyEl.style.display = 'block';
      return;
    }

    ganttEl.style.display = 'block';
    emptyEl.style.display = 'none';

    gantt = new Gantt('#gantt', tasks, {
      view_mode: currentViewMode,
      date_format: 'YYYY-MM-DD HH:mm',
      bar_height: 30,
      bar_corner_radius: 4,
      arrow_curve: 5,
      padding: 18,
      popup_trigger: 'click',
      language: 'ja',
      custom_popup_html: buildPopupHtml,

      on_click: function(task) {
        UIManager.showTaskDetailsModal(DataManager.getOrderById(task.id));
      },

      on_date_change: function(task, start, end) {
        handleDateChange(task, start, end);
      }
    });

    setupContextMenu();
  }

  function handleDateChange(task, start, end) {
    var formatDT = function(d) {
      var dt = new Date(d);
      var y = dt.getFullYear();
      var mo = ('0' + (dt.getMonth() + 1)).slice(-2);
      var da = ('0' + dt.getDate()).slice(-2);
      var h = ('0' + dt.getHours()).slice(-2);
      var mi = ('0' + dt.getMinutes()).slice(-2);
      return { date: y + '-' + mo + '-' + da, time: h + ':' + mi };
    };

    var s = formatDT(start);
    var e = formatDT(end);

    DataManager.updateOrder(task.id, {
      loadDate: s.date,
      loadTime: s.time,
      unloadDate: e.date,
      unloadTime: e.time
    })
    .then(function() {
      UIManager.showToast('日程を更新しました。', 'success');
    })
    .catch(function(err) {
      UIManager.showToast('日程更新に失敗: ' + err.message, 'danger');
      refresh();
    });
  }

  function setupContextMenu() {
    var ganttEl = document.getElementById('gantt');
    var menu = document.getElementById('customContextMenu');
    var selectedTaskId = null;

    ganttEl.addEventListener('contextmenu', function(e) {
      var bar = e.target.closest('.bar-wrapper');
      if (!bar) return;
      e.preventDefault();

      var taskId = bar.getAttribute('data-id');
      if (!taskId) return;

      selectedTaskId = taskId;
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.style.display = 'block';
    });

    document.addEventListener('click', function() {
      menu.style.display = 'none';
    });

    document.getElementById('ctxEdit').addEventListener('click', function() {
      if (selectedTaskId) {
        UIManager.showTaskDetailsModal(DataManager.getOrderById(selectedTaskId));
      }
    });

    document.getElementById('ctxUnassign').addEventListener('click', function() {
      if (!selectedTaskId) return;
      DataManager.updateOrder(selectedTaskId, {
        number: '',
        status: STATUS.UNASSIGNED
      }).then(function() {
        UIManager.showToast('割当を解除しました。', 'info');
      }).catch(function(err) {
        UIManager.showToast('割当解除に失敗: ' + err.message, 'danger');
      });
    });
  }

  function refresh() {
    var allOrders = DataManager.getOrders();
    var ganttEl = document.getElementById('gantt');
    var emptyEl = document.getElementById('ganttEmpty');

    var tasks = mapOrdersToGanttTasks(allOrders);

    if (tasks.length === 0) {
      DOM.clear(ganttEl);
      ganttEl.style.display = 'none';
      emptyEl.style.display = 'block';
      gantt = null;
      return;
    }

    ganttEl.style.display = 'block';
    emptyEl.style.display = 'none';

    if (gantt) {
      try {
        gantt.refresh(tasks);
      } catch (e) {
        // refresh失敗時はGanttを再生成
        console.warn('Gantt refresh failed, reinitializing:', e.message);
        DOM.clear(ganttEl);
        gantt = null;
        init();
      }
    } else {
      init();
    }
  }

  function changeViewMode(mode) {
    currentViewMode = mode;
    if (gantt) {
      gantt.change_view_mode(mode);
    }
  }

  return {
    init: init,
    refresh: refresh,
    changeViewMode: changeViewMode
  };
})();


/* ========================================================
 * UIManager - サイドバー、ドラッグ&ドロップ、モーダル、Toast
 * ======================================================== */
var UIManager = (function() {
  var draggedOrderId = null;

  function renderUnassignedPool() {
    var pool = document.getElementById('unassignedPool');
    var countBadge = document.getElementById('unassignedCount');
    var unassigned = DataManager.getUnassignedOrders();

    countBadge.textContent = unassigned.length;
    DOM.clear(pool);

    if (unassigned.length === 0) {
      pool.appendChild(
        DOM.el('p', { className: 'text-muted small', textContent: '全ての受注が割当済みです。' })
      );
      return;
    }

    unassigned.forEach(function(order) {
      var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
      var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');

      var card = DOM.el('div', {
        className: 'card order-card',
        draggable: 'true',
        'data-order-id': order.requestId
      }, [
        DOM.el('div', { className: 'card-body py-2 px-3' }, [
          DOM.el('div', { className: 'card-title mb-1', textContent: order.shipper }),
          DOM.el('p', { className: 'card-text mb-1', textContent: order.cargoName }),
          DOM.el('p', { className: 'card-text' }, [
            DOM.el('small', { textContent: order.loadDate + ' ' + (order.loadTime || '') }),
            document.createElement('br'),
            DOM.el('small', { textContent: loadLoc + ' → ' + unloadLoc })
          ]),
          order.requestedType
            ? DOM.el('span', { className: 'badge bg-light text-dark mt-1', textContent: order.requestedType })
            : null
        ].filter(Boolean))
      ]);

      card.addEventListener('dragstart', function(e) {
        draggedOrderId = order.requestId;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', order.requestId);
      });

      card.addEventListener('dragend', function() {
        card.classList.remove('dragging');
        draggedOrderId = null;
      });

      pool.appendChild(card);
    });
  }

  function setupDragDrop() {
    var dropZone = document.getElementById('ganttDropZone');

    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', function() {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropZone.classList.remove('drag-over');

      var orderId = e.dataTransfer.getData('text/plain');
      if (!orderId) return;

      showVehicleSelectModal(orderId);
    });
  }

  function showVehicleSelectModal(orderId) {
    var vehicles = DataManager.getVehicles();
    var list = document.getElementById('vehicleSelectList');
    DOM.clear(list);

    vehicles.forEach(function(v) {
      var item = DOM.el('button', { className: 'list-group-item list-group-item-action' }, [
        DOM.el('div', { className: 'd-flex justify-content-between align-items-center' }, [
          DOM.el('div', {}, [
            DOM.el('strong', { textContent: v.number }),
            DOM.el('small', { className: 'text-muted ms-2', textContent: v.vehicleType })
          ]),
          DOM.el('small', { textContent: v.driverName })
        ])
      ]);

      item.addEventListener('click', function() {
        assignOrderToVehicle(orderId, v.number);
        bootstrap.Modal.getInstance(document.getElementById('vehicleSelectModal')).hide();
      });

      list.appendChild(item);
    });

    var modal = new bootstrap.Modal(document.getElementById('vehicleSelectModal'));
    modal.show();
  }

  function assignOrderToVehicle(orderId, vehicleNumber) {
    DataManager.updateOrder(orderId, {
      number: vehicleNumber,
      status: STATUS.ASSIGNED
    }).then(function() {
      showToast('受注を車両に割り当てました。', 'success');
    }).catch(function(err) {
      showToast('割当に失敗: ' + err.message, 'danger');
    });
  }

  function showTaskDetailsModal(order) {
    if (!order) return;
    var body = document.getElementById('taskDetailsBody');
    DOM.clear(body);

    var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
    var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');

    var fields = [
      ['依頼ID', order.requestId],
      ['受付日', order.receivedDate],
      ['荷主', order.shipper],
      ['積込日時', order.loadDate + ' ' + (order.loadTime || '')],
      ['積込地', loadLoc],
      ['品名', order.cargoName],
      ['荷卸日時', order.unloadDate + ' ' + (order.unloadTime || '')],
      ['荷卸地', unloadLoc],
      ['依頼車種', order.requestedType],
      ['ナンバー', order.number],
      ['車番', order.vehicleNumber],
      ['車種', order.vehicleType],
      ['運転手', order.driverName],
      ['ステータス', order.status]
    ];

    var table = DOM.el('table', { className: 'table table-sm' });
    var tbody = document.createElement('tbody');
    fields.forEach(function(field) {
      var tr = DOM.el('tr', {}, [
        DOM.el('th', { style: { width: '30%' }, textContent: field[0] }),
        DOM.el('td', { textContent: field[1] || '' })
      ]);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    body.appendChild(table);

    var modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
    modal.show();
  }

  function showToast(message, type) {
    type = type || 'info';
    var container = document.getElementById('toastContainer');

    var closeBtn = DOM.el('button', {
      type: 'button',
      className: 'btn-close btn-close-white me-2 m-auto',
      'data-bs-dismiss': 'toast'
    });

    var toastEl = DOM.el('div', {
      className: 'toast align-items-center text-bg-' + type + ' border-0',
      role: 'alert'
    }, [
      DOM.el('div', { className: 'd-flex' }, [
        DOM.el('div', { className: 'toast-body', textContent: message }),
        closeBtn
      ])
    ]);

    container.appendChild(toastEl);
    var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', function() {
      toastEl.remove();
    });
  }

  function setupCSVImport() {
    var fileInput = document.getElementById('csvFileInput');
    var importBtn = document.getElementById('csvImportBtn');
    var preview = document.getElementById('csvPreview');
    var previewInfo = document.getElementById('csvPreviewInfo');
    var progress = document.getElementById('csvImportProgress');
    var csvContent = null;

    fileInput.addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (!file) {
        importBtn.disabled = true;
        preview.style.display = 'none';
        return;
      }

      var reader = new FileReader();
      reader.onload = function(event) {
        csvContent = event.target.result;
        var lines = csvContent.split('\n').filter(function(l) { return l.trim(); });
        previewInfo.textContent = lines.length + ' 行を検出 (ヘッダー含む)';
        preview.style.display = 'block';
        importBtn.disabled = false;
      };
      reader.readAsText(file, 'UTF-8');
    });

    importBtn.addEventListener('click', function() {
      if (!csvContent) return;
      importBtn.disabled = true;
      progress.style.display = 'block';

      google.script.run
        .withSuccessHandler(function(result) {
          progress.style.display = 'none';
          bootstrap.Modal.getInstance(document.getElementById('csvImportModal')).hide();

          if (result.success) {
            showToast(result.imported + ' 件インポートしました。', 'success');
            if (result.warnings && result.warnings.length > 0) {
              showToast('警告: ' + result.warnings.length + ' 件のエラー行', 'warning');
            }
            DataManager.loadData();
          } else {
            showToast('インポート失敗: ' + (result.error || '不明なエラー'), 'danger');
            importBtn.disabled = false;
          }

          fileInput.value = '';
          csvContent = null;
          preview.style.display = 'none';
        })
        .withFailureHandler(function(err) {
          progress.style.display = 'none';
          showToast('インポートエラー: ' + err.message, 'danger');
          importBtn.disabled = false;
        })
        .importCSV(csvContent);
    });
  }

  return {
    renderUnassignedPool: renderUnassignedPool,
    setupDragDrop: setupDragDrop,
    showTaskDetailsModal: showTaskDetailsModal,
    showToast: showToast,
    setupCSVImport: setupCSVImport,
    showVehicleSelectModal: showVehicleSelectModal
  };
})();


/* ========================================================
 * ユーティリティ
 * ======================================================== */
function escapeHtml(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}


/* ========================================================
 * アプリ初期化
 * ======================================================== */
document.addEventListener('DOMContentLoaded', function() {
  var overlay = document.getElementById('loadingOverlay');

  DataManager.subscribe(function() {
    UIManager.renderUnassignedPool();
    GanttManager.refresh();
  });

  DataManager.loadData()
    .then(function() {
      GanttManager.init();
      UIManager.renderUnassignedPool();
      UIManager.setupDragDrop();
      UIManager.setupCSVImport();
      overlay.style.display = 'none';
    })
    .catch(function(err) {
      DOM.clear(overlay);
      overlay.appendChild(
        DOM.el('div', { className: 'text-center text-danger' }, [
          DOM.el('p', { textContent: 'データの読み込みに失敗しました。' }),
          DOM.el('p', { className: 'small', textContent: err.message }),
          DOM.el('button', {
            className: 'btn btn-primary',
            textContent: '再読み込み'
          })
        ])
      );
      overlay.querySelector('button').addEventListener('click', function() {
        location.reload();
      });
    });

  document.querySelectorAll('input[name="viewMode"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      GanttManager.changeViewMode(this.value);
    });
  });
});
</script>
