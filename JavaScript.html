<script>
/**
 * KUBOXT 配車プランナー - クライアントサイドロジック
 * モジュール: DataManager, ScheduleManager, UIManager, StatusManager
 */

// ステータス定数 (サーバーのCONFIG.STATUSと一致させる)
var STATUS = {
  UNASSIGNED: '未割当',
  ASSIGNED: '割当済',
  EN_ROUTE: '配送中',
  COMPLETED: '完了'
};

/* ========================================================
 * DataManager - データ管理 + Observer パターン
 * ======================================================== */
var DataManager = (function() {
  var orders = [];
  var vehicles = [];
  var observers = [];

  function subscribe(fn) {
    observers.push(fn);
  }

  function notifyObservers() {
    observers.forEach(function(fn) { fn(); });
  }

  function callServer(fnName) {
    var args = Array.prototype.slice.call(arguments, 1);
    return new Promise(function(resolve, reject) {
      var runner = google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject);
      runner[fnName].apply(runner, args);
    });
  }

  function loadData() {
    return callServer('getData').then(function(result) {
      if (!result.success) {
        throw new Error(result.error || 'データの取得に失敗しました。');
      }
      orders = result.orders || [];
      vehicles = result.vehicles || [];
      notifyObservers();
      return result;
    });
  }

  function getOrders() { return orders; }
  function getVehicles() { return vehicles; }

  function getUnassignedOrders() {
    return orders.filter(function(o) { return o.status === STATUS.UNASSIGNED || !o.status; });
  }

  function getAssignedOrders() {
    return orders.filter(function(o) { return o.status && o.status !== STATUS.UNASSIGNED; });
  }

  function getOrderById(requestId) {
    for (var i = 0; i < orders.length; i++) {
      if (orders[i].requestId === requestId) return orders[i];
    }
    return null;
  }

  /**
   * Optimistic更新: ローカルを即座に更新 → サーバー同期 → 失敗時ロールバック
   */
  function updateOrder(orderId, updates) {
    var order = getOrderById(orderId);
    if (!order) return Promise.reject(new Error('受注が見つかりません'));

    var snapshot = JSON.parse(JSON.stringify(order));

    // ローカル即時更新
    Object.keys(updates).forEach(function(key) {
      order[key] = updates[key];
    });

    // ナンバー変更時は車両マスターから自動反映
    if (updates.number) {
      var vehicle = getVehicleByNumber(updates.number);
      if (vehicle) {
        order.vehicleNumber = vehicle.radioNumber || '';
        order.vehicleType = vehicle.vehicleType;
        order.driverName = vehicle.driverName;
      }
    } else if (updates.number === '') {
      order.vehicleNumber = '';
      order.vehicleType = '';
      order.driverName = '';
    }

    notifyObservers();

    // サーバー同期
    return callServer('updateOrder', orderId, updates)
      .then(function(result) {
        if (result && !result.success) {
          throw new Error(result.error || '更新に失敗しました。');
        }
        return result;
      })
      .catch(function(err) {
        // ロールバック
        Object.keys(snapshot).forEach(function(key) {
          order[key] = snapshot[key];
        });
        notifyObservers();
        throw err;
      });
  }

  function getVehicleByNumber(number) {
    for (var i = 0; i < vehicles.length; i++) {
      if (vehicles[i].number === number) return vehicles[i];
    }
    return null;
  }

  return {
    loadData: loadData,
    getOrders: getOrders,
    getVehicles: getVehicles,
    getUnassignedOrders: getUnassignedOrders,
    getAssignedOrders: getAssignedOrders,
    getOrderById: getOrderById,
    getVehicleByNumber: getVehicleByNumber,
    updateOrder: updateOrder,
    subscribe: subscribe,
    callServer: callServer
  };
})();


/* ========================================================
 * DOM ヘルパー - 安全な要素生成 (innerHTML不使用)
 * ======================================================== */
var DOM = {
  el: function(tag, attrs, children) {
    var el = document.createElement(tag);
    if (attrs) {
      Object.keys(attrs).forEach(function(key) {
        if (key === 'className') {
          el.className = attrs[key];
        } else if (key === 'textContent') {
          el.textContent = attrs[key];
        } else if (key === 'style' && typeof attrs[key] === 'object') {
          Object.keys(attrs[key]).forEach(function(prop) {
            el.style[prop] = attrs[key][prop];
          });
        } else {
          el.setAttribute(key, attrs[key]);
        }
      });
    }
    if (children) {
      children.forEach(function(child) {
        if (typeof child === 'string') {
          el.appendChild(document.createTextNode(child));
        } else if (child) {
          el.appendChild(child);
        }
      });
    }
    return el;
  },
  clear: function(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }
};


/* ========================================================
 * ScheduleManager - 車両スケジュールグリッド
 * 横軸: 24時間 (1日) / 縦軸: 車両
 * ======================================================== */
var ScheduleManager = (function() {
  var selectedDate = '';
  var vehicleTypeFilter = '';
  var SLOT_WIDTH = 80; // ピクセル/時
  var HOURS = 24;

  function getTodayStr() {
    var d = new Date();
    return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
  }

  function getSelectedDate() {
    return selectedDate || getTodayStr();
  }

  function formatDateStr(d) {
    return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
  }

  function setDate(dateStr) {
    selectedDate = dateStr;
    document.getElementById('scheduleDate').value = dateStr;
    // サイドバーの積込日フィルターと同期
    document.getElementById('filterLoadDate').value = dateStr;
    UIManager.syncSidebarDate(dateStr);
    render();
  }

  function getFilteredVehicles() {
    var vehicles = DataManager.getVehicles();
    if (vehicleTypeFilter) {
      vehicles = vehicles.filter(function(v) {
        return v.vehicleType === vehicleTypeFilter;
      });
    }
    return vehicles;
  }

  /** 指定日に稼働する注文を取得 (日をまたぐ案件も対応) */
  function getOrdersForVehicle(vehicleNumber) {
    var date = getSelectedDate();
    return DataManager.getOrders().filter(function(o) {
      if (o.number !== vehicleNumber) return false;
      var loadD = o.loadDate || '';
      var unloadD = o.unloadDate || loadD;
      return loadD <= date && unloadD >= date;
    });
  }

  /** 日をまたぐ案件の当日表示範囲を計算 */
  function getBarTimes(order) {
    var date = getSelectedDate();
    var loadD = order.loadDate || '';
    var unloadD = order.unloadDate || loadD;
    var startTime = (loadD === date) ? (order.loadTime || '00:00') : '00:00';
    var endTime = (unloadD === date) ? (order.unloadTime || '23:59') : '23:59';
    return { start: startTime, end: endTime };
  }

  function timeToMinutes(timeStr) {
    if (!timeStr) return 0;
    var parts = timeStr.split(':');
    return (parseInt(parts[0], 10) || 0) * 60 + (parseInt(parts[1], 10) || 0);
  }

  function getStatusColor(status) {
    switch (status) {
      case STATUS.ASSIGNED: return '#0d6efd';
      case STATUS.EN_ROUTE: return '#ffc107';
      case STATUS.COMPLETED: return '#198754';
      default: return '#6c757d';
    }
  }

  function renderHeader() {
    var header = document.getElementById('scheduleHeader');
    DOM.clear(header);

    // 車両ラベルヘッダー
    header.appendChild(DOM.el('div', { className: 'schedule-vehicle-header', textContent: '車両' }));

    // 時間ラベル
    var timeLabels = DOM.el('div', { className: 'schedule-time-labels', style: { position: 'relative' } });
    for (var h = 0; h < HOURS; h++) {
      var label = DOM.el('div', {
        className: 'schedule-time-label',
        style: { width: SLOT_WIDTH + 'px', minWidth: SLOT_WIDTH + 'px' },
        textContent: ('0' + h).slice(-2) + ':00'
      });
      timeLabels.appendChild(label);
    }

    // 今日なら現在時刻インジケーター (ヘッダー)
    if (getSelectedDate() === getTodayStr()) {
      var now = new Date();
      var nowMin = now.getHours() * 60 + now.getMinutes();
      var leftPx = nowMin / 60 * SLOT_WIDTH;
      timeLabels.appendChild(DOM.el('div', {
        className: 'current-time-header-indicator',
        style: { left: leftPx + 'px' }
      }));
    }

    header.appendChild(timeLabels);
  }

  function render() {
    var body = document.getElementById('scheduleBody');
    var emptyEl = document.getElementById('scheduleEmpty');
    var vehicles = getFilteredVehicles();

    DOM.clear(body);
    renderHeader();

    if (vehicles.length === 0) {
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';

    var timelineWidth = SLOT_WIDTH * HOURS;

    vehicles.forEach(function(vehicle) {
      var orders = getOrdersForVehicle(vehicle.number);

      var row = DOM.el('div', { className: 'schedule-row' });

      // 車両ラベル (左固定列)
      var label = DOM.el('div', { className: 'schedule-vehicle-label' }, [
        DOM.el('div', { className: 'vehicle-number', textContent: vehicle.number }),
        DOM.el('div', { className: 'vehicle-driver', textContent: vehicle.driverName || '' }),
        DOM.el('div', { className: 'vehicle-type-text', textContent: vehicle.vehicleType || '' })
      ]);

      // タイムライン
      var timeline = DOM.el('div', {
        className: 'schedule-timeline',
        style: { width: timelineWidth + 'px', minWidth: timelineWidth + 'px' }
      });
      timeline.setAttribute('data-vehicle', vehicle.number);

      // グリッド線
      for (var h = 0; h < HOURS; h++) {
        var lineClass = 'schedule-grid-line';
        if (h === 6 || h === 12 || h === 18) lineClass += ' hour-' + h;
        timeline.appendChild(DOM.el('div', {
          className: lineClass,
          style: { left: (h * SLOT_WIDTH) + 'px' }
        }));
      }

      // 受注バー
      orders.forEach(function(order) {
        var times = getBarTimes(order);
        var startMin = timeToMinutes(times.start);
        var endMin = timeToMinutes(times.end);
        if (endMin <= startMin) endMin = Math.min(startMin + 60, 1440);

        var leftPx = startMin / 60 * SLOT_WIDTH;
        var widthPx = Math.max((endMin - startMin) / 60 * SLOT_WIDTH, 20);

        var barColor = getStatusColor(order.status);
        var textColor = (order.status === STATUS.EN_ROUTE) ? '#212529' : '#fff';

        var bar = DOM.el('div', {
          className: 'schedule-bar',
          style: {
            left: leftPx + 'px',
            width: widthPx + 'px',
            backgroundColor: barColor,
            color: textColor
          }
        }, [
          DOM.el('span', { textContent: order.shipper + ' - ' + order.cargoName })
        ]);
        bar.setAttribute('data-order-id', order.requestId);
        bar.title = order.shipper + ' ' + order.cargoName +
          '\n' + times.start + ' - ' + times.end +
          '\n' + [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ') +
          ' → ' + [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');

        // クリックで詳細モーダル
        bar.addEventListener('click', function(e) {
          e.stopPropagation();
          UIManager.showTaskDetailsModal(order);
        });

        timeline.appendChild(bar);
      });

      // 今日なら現在時刻インジケーター
      if (getSelectedDate() === getTodayStr()) {
        var now = new Date();
        var nowMin = now.getHours() * 60 + now.getMinutes();
        timeline.appendChild(DOM.el('div', {
          className: 'current-time-indicator',
          style: { left: (nowMin / 60 * SLOT_WIDTH) + 'px' }
        }));
      }

      // ドラッグ&ドロップ: サイドバーから車両行へ直接割当
      timeline.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        row.classList.add('drag-over');
      });

      timeline.addEventListener('dragleave', function(e) {
        if (!timeline.contains(e.relatedTarget)) {
          row.classList.remove('drag-over');
        }
      });

      timeline.addEventListener('drop', function(e) {
        e.preventDefault();
        row.classList.remove('drag-over');
        var orderId = e.dataTransfer.getData('text/plain');
        if (orderId) {
          assignOrder(orderId, vehicle.number);
        }
      });

      row.appendChild(label);
      row.appendChild(timeline);
      body.appendChild(row);
    });
  }

  function assignOrder(orderId, vehicleNumber) {
    DataManager.updateOrder(orderId, {
      number: vehicleNumber,
      status: STATUS.ASSIGNED
    }).then(function() {
      UIManager.showToast('車両 ' + vehicleNumber + ' に割当しました。', 'success');
    }).catch(function(err) {
      UIManager.showToast('割当に失敗: ' + err.message, 'danger');
    });
  }

  function populateFilterOptions() {
    var vehicles = DataManager.getVehicles();
    var types = {};
    vehicles.forEach(function(v) { if (v.vehicleType) types[v.vehicleType] = true; });

    var typeSelect = document.getElementById('scheduleVehicleType');
    var currentVal = typeSelect.value;
    while (typeSelect.options.length > 1) typeSelect.remove(1);
    Object.keys(types).sort().forEach(function(t) {
      typeSelect.add(new Option(t, t));
    });
    typeSelect.value = currentVal;
  }

  function setupContextMenu() {
    var body = document.getElementById('scheduleBody');
    var menu = document.getElementById('customContextMenu');
    var selectedOrderId = null;

    body.addEventListener('contextmenu', function(e) {
      var bar = e.target.closest('.schedule-bar');
      if (!bar) return;
      e.preventDefault();

      selectedOrderId = bar.getAttribute('data-order-id');
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.style.display = 'block';
    });

    document.addEventListener('click', function() {
      menu.style.display = 'none';
    });

    document.getElementById('ctxEdit').addEventListener('click', function() {
      if (selectedOrderId) {
        UIManager.showTaskDetailsModal(DataManager.getOrderById(selectedOrderId));
      }
    });

    document.getElementById('ctxUnassign').addEventListener('click', function() {
      if (!selectedOrderId) return;
      DataManager.updateOrder(selectedOrderId, {
        number: '',
        status: STATUS.UNASSIGNED
      }).then(function() {
        UIManager.showToast('割当を解除しました。', 'info');
      }).catch(function(err) {
        UIManager.showToast('割当解除に失敗: ' + err.message, 'danger');
      });
    });
  }

  function setup() {
    var today = getTodayStr();
    selectedDate = today;
    document.getElementById('scheduleDate').value = today;
    // サイドバーも同日に同期
    document.getElementById('filterLoadDate').value = today;

    document.getElementById('scheduleDate').addEventListener('change', function() {
      setDate(this.value);
    });

    document.getElementById('scheduleVehicleType').addEventListener('change', function() {
      vehicleTypeFilter = this.value;
      render();
    });

    document.getElementById('schedulePrevDay').addEventListener('click', function() {
      var d = new Date(getSelectedDate());
      d.setDate(d.getDate() - 1);
      setDate(formatDateStr(d));
    });

    document.getElementById('scheduleNextDay').addEventListener('click', function() {
      var d = new Date(getSelectedDate());
      d.setDate(d.getDate() + 1);
      setDate(formatDateStr(d));
    });

    document.getElementById('scheduleToday').addEventListener('click', function() {
      setDate(getTodayStr());
    });

    setupContextMenu();
    populateFilterOptions();
  }

  return {
    render: render,
    setup: setup,
    populateFilterOptions: populateFilterOptions,
    getSelectedDate: getSelectedDate
  };
})();


/* ========================================================
 * UIManager - サイドバー、モーダル、Toast
 * ======================================================== */
var UIManager = (function() {
  var draggedOrderId = null;
  var sidebarFilters = {
    requestedType: '',
    loadDate: ''
  };

  function syncSidebarDate(dateStr) {
    sidebarFilters.loadDate = dateStr;
    renderUnassignedPool();
  }

  function getFilteredUnassignedOrders() {
    var unassigned = DataManager.getUnassignedOrders();
    return unassigned.filter(function(o) {
      if (sidebarFilters.requestedType && o.requestedType !== sidebarFilters.requestedType) {
        return false;
      }
      if (sidebarFilters.loadDate && o.loadDate !== sidebarFilters.loadDate) {
        return false;
      }
      return true;
    });
  }

  function populateSidebarFilterOptions() {
    var select = document.getElementById('filterRequestedType');
    var currentVal = select.value;
    var types = {};
    DataManager.getUnassignedOrders().forEach(function(o) {
      if (o.requestedType) types[o.requestedType] = true;
    });
    while (select.options.length > 1) select.remove(1);
    Object.keys(types).sort().forEach(function(t) {
      select.add(new Option(t, t));
    });
    select.value = currentVal;
  }

  function setupSidebarFilters() {
    document.getElementById('filterRequestedType').addEventListener('change', function() {
      sidebarFilters.requestedType = this.value;
      renderUnassignedPool();
    });
    document.getElementById('filterLoadDate').addEventListener('change', function() {
      sidebarFilters.loadDate = this.value;
      renderUnassignedPool();
    });
    document.getElementById('clearSidebarFilter').addEventListener('click', function() {
      sidebarFilters.requestedType = '';
      sidebarFilters.loadDate = '';
      document.getElementById('filterRequestedType').value = '';
      document.getElementById('filterLoadDate').value = '';
      renderUnassignedPool();
    });
  }

  function renderUnassignedPool() {
    var pool = document.getElementById('unassignedPool');
    var countBadge = document.getElementById('unassignedCount');
    var unassigned = getFilteredUnassignedOrders();
    populateSidebarFilterOptions();

    countBadge.textContent = unassigned.length;
    DOM.clear(pool);

    if (unassigned.length === 0) {
      pool.appendChild(
        DOM.el('p', { className: 'text-muted small', textContent: '未割当の受注はありません。' })
      );
      return;
    }

    unassigned.forEach(function(order) {
      var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
      var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');

      var card = DOM.el('div', {
        className: 'card order-card',
        draggable: 'true',
        'data-order-id': order.requestId
      }, [
        DOM.el('div', { className: 'card-body py-2 px-3' }, [
          DOM.el('div', { className: 'card-title mb-1', textContent: order.shipper }),
          DOM.el('p', { className: 'card-text mb-1', textContent: order.cargoName }),
          DOM.el('p', { className: 'card-text' }, [
            DOM.el('small', { textContent: order.loadDate + ' ' + (order.loadTime || '') }),
            document.createElement('br'),
            DOM.el('small', { textContent: loadLoc + ' → ' + unloadLoc })
          ]),
          order.requestedType
            ? DOM.el('span', { className: 'badge bg-light text-dark mt-1', textContent: order.requestedType })
            : null
        ].filter(Boolean))
      ]);

      card.addEventListener('dragstart', function(e) {
        draggedOrderId = order.requestId;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', order.requestId);
      });

      card.addEventListener('dragend', function() {
        card.classList.remove('dragging');
        draggedOrderId = null;
      });

      pool.appendChild(card);
    });
  }

  function showTaskDetailsModal(order) {
    if (!order) return;
    var body = document.getElementById('taskDetailsBody');
    DOM.clear(body);

    var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
    var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');

    var fields = [
      ['依頼ID', order.requestId],
      ['受付日', order.receivedDate],
      ['荷主', order.shipper],
      ['積込日時', order.loadDate + ' ' + (order.loadTime || '')],
      ['積込地', loadLoc],
      ['品名', order.cargoName],
      ['荷卸日時', order.unloadDate + ' ' + (order.unloadTime || '')],
      ['荷卸地', unloadLoc],
      ['依頼車種', order.requestedType],
      ['ナンバー', order.number],
      ['車番', order.vehicleNumber],
      ['車種', order.vehicleType],
      ['運転手', order.driverName],
      ['ステータス', order.status]
    ];

    var table = DOM.el('table', { className: 'table table-sm' });
    var tbody = document.createElement('tbody');
    fields.forEach(function(field) {
      var tr = DOM.el('tr', {}, [
        DOM.el('th', { style: { width: '30%' }, textContent: field[0] }),
        DOM.el('td', { textContent: field[1] || '' })
      ]);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    body.appendChild(table);

    var modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
    modal.show();
  }

  function showToast(message, type) {
    type = type || 'info';
    var container = document.getElementById('toastContainer');

    var closeBtn = DOM.el('button', {
      type: 'button',
      className: 'btn-close btn-close-white me-2 m-auto',
      'data-bs-dismiss': 'toast'
    });

    var toastEl = DOM.el('div', {
      className: 'toast align-items-center text-bg-' + type + ' border-0',
      role: 'alert'
    }, [
      DOM.el('div', { className: 'd-flex' }, [
        DOM.el('div', { className: 'toast-body', textContent: message }),
        closeBtn
      ])
    ]);

    container.appendChild(toastEl);
    var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', function() {
      toastEl.remove();
    });
  }

  function setupCSVImport() {
    var fileInput = document.getElementById('csvFileInput');
    var importBtn = document.getElementById('csvImportBtn');
    var preview = document.getElementById('csvPreview');
    var previewInfo = document.getElementById('csvPreviewInfo');
    var progress = document.getElementById('csvImportProgress');
    var csvContent = null;

    fileInput.addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (!file) {
        importBtn.disabled = true;
        preview.style.display = 'none';
        return;
      }

      var reader = new FileReader();
      reader.onload = function(event) {
        csvContent = event.target.result;
        var lines = csvContent.split('\n').filter(function(l) { return l.trim(); });
        previewInfo.textContent = lines.length + ' 行を検出 (ヘッダー含む)';
        preview.style.display = 'block';
        importBtn.disabled = false;
      };
      reader.readAsText(file, 'UTF-8');
    });

    importBtn.addEventListener('click', function() {
      if (!csvContent) return;
      importBtn.disabled = true;
      progress.style.display = 'block';

      google.script.run
        .withSuccessHandler(function(result) {
          progress.style.display = 'none';
          bootstrap.Modal.getInstance(document.getElementById('csvImportModal')).hide();

          if (result.success) {
            showToast(result.imported + ' 件インポートしました。', 'success');
            if (result.warnings && result.warnings.length > 0) {
              showToast('警告: ' + result.warnings.length + ' 件のエラー行', 'warning');
            }
            DataManager.loadData();
          } else {
            showToast('インポート失敗: ' + (result.error || '不明なエラー'), 'danger');
            importBtn.disabled = false;
          }

          fileInput.value = '';
          csvContent = null;
          preview.style.display = 'none';
        })
        .withFailureHandler(function(err) {
          progress.style.display = 'none';
          showToast('インポートエラー: ' + err.message, 'danger');
          importBtn.disabled = false;
        })
        .importCSV(csvContent);
    });
  }

  return {
    renderUnassignedPool: renderUnassignedPool,
    setupSidebarFilters: setupSidebarFilters,
    syncSidebarDate: syncSidebarDate,
    showTaskDetailsModal: showTaskDetailsModal,
    showToast: showToast,
    setupCSVImport: setupCSVImport
  };
})();


/* ========================================================
 * StatusManager - 配車状況確認画面
 * ======================================================== */
var StatusManager = (function() {
  var filters = {
    date: '',
    status: '',
    groupBy: 'date'
  };

  function getFilteredOrders() {
    var orders = DataManager.getOrders();
    return orders.filter(function(o) {
      if (filters.date) {
        var loadD = o.loadDate || '';
        var unloadD = o.unloadDate || loadD;
        if (loadD !== filters.date && unloadD !== filters.date) {
          if (!(loadD <= filters.date && unloadD >= filters.date)) {
            return false;
          }
        }
      }
      if (filters.status) {
        var orderStatus = o.status || STATUS.UNASSIGNED;
        if (orderStatus !== filters.status) return false;
      }
      return true;
    });
  }

  function groupOrders(orders, groupBy) {
    var groups = {};
    orders.forEach(function(o) {
      var key;
      switch (groupBy) {
        case 'driver':
          key = o.driverName || '(未割当)';
          break;
        case 'vehicleType':
          key = o.vehicleType || o.requestedType || '(車種不明)';
          break;
        case 'shipper':
          key = o.shipper || '(荷主不明)';
          break;
        case 'date':
        default:
          key = o.loadDate || '(日付なし)';
          break;
      }
      if (!groups[key]) groups[key] = [];
      groups[key].push(o);
    });
    return groups;
  }

  function getStatusColor(status) {
    switch (status) {
      case STATUS.ASSIGNED: return '#0d6efd';
      case STATUS.EN_ROUTE: return '#ffc107';
      case STATUS.COMPLETED: return '#198754';
      default: return '#6c757d';
    }
  }

  function getStatusBadgeSuffix(status) {
    switch (status) {
      case STATUS.ASSIGNED: return 'assigned';
      case STATUS.EN_ROUTE: return 'enroute';
      case STATUS.COMPLETED: return 'completed';
      default: return 'unassigned';
    }
  }

  function updateSummary() {
    var orders = DataManager.getOrders();
    var total = orders.length;
    var unassigned = 0, assigned = 0, completed = 0;
    orders.forEach(function(o) {
      if (o.status === STATUS.UNASSIGNED || !o.status) unassigned++;
      else if (o.status === STATUS.COMPLETED) completed++;
      else assigned++;
    });
    document.getElementById('summaryTotal').textContent = total;
    document.getElementById('summaryUnassigned').textContent = unassigned;
    document.getElementById('summaryAssigned').textContent = assigned;
    document.getElementById('summaryCompleted').textContent = completed;
  }

  function render() {
    var accordion = document.getElementById('statusAccordion');
    var emptyEl = document.getElementById('statusEmpty');
    DOM.clear(accordion);

    updateSummary();

    var filtered = getFilteredOrders();
    if (filtered.length === 0) {
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';

    var groups = groupOrders(filtered, filters.groupBy);
    var sortedKeys = Object.keys(groups).sort();

    sortedKeys.forEach(function(key, index) {
      var items = groups[key];
      var collapseId = 'statusGroup' + index;

      var unassignedCount = items.filter(function(o) {
        return o.status === STATUS.UNASSIGNED || !o.status;
      }).length;

      var headerBtn = DOM.el('button', {
        className: 'accordion-button' + (index > 0 ? ' collapsed' : ''),
        type: 'button',
        'data-bs-toggle': 'collapse',
        'data-bs-target': '#' + collapseId
      }, [
        DOM.el('span', { textContent: key }),
        DOM.el('span', { className: 'badge bg-secondary ms-2', textContent: items.length + '件' }),
        unassignedCount > 0
          ? DOM.el('span', { className: 'badge bg-danger ms-1', textContent: '未配車 ' + unassignedCount })
          : null
      ].filter(Boolean));

      var header = DOM.el('h2', { className: 'accordion-header' }, [headerBtn]);

      var bodyInner = DOM.el('div', { className: 'accordion-body p-0' });

      items.forEach(function(order) {
        var loadLoc = [order.loadLocation1, order.loadLocation2].filter(Boolean).join(' ');
        var unloadLoc = [order.unloadLocation1, order.unloadLocation2].filter(Boolean).join(' ');
        var orderStatus = order.status || STATUS.UNASSIGNED;

        var editBtn = DOM.el('button', {
          className: 'btn btn-outline-primary btn-sm me-1',
          textContent: '編集',
          title: '受注を編集'
        });

        var unassignBtn = null;
        if (orderStatus !== STATUS.UNASSIGNED) {
          unassignBtn = DOM.el('button', {
            className: 'btn btn-outline-danger btn-sm',
            textContent: '解除',
            title: '割当を解除'
          });
        }

        var actionsChildren = [editBtn];
        if (unassignBtn) actionsChildren.push(unassignBtn);

        var driverInfo = null;
        if (order.driverName) {
          driverInfo = DOM.el('div', { className: 'small' }, [
            DOM.el('span', { className: 'text-primary', textContent: order.driverName }),
            DOM.el('span', { className: 'text-muted ms-2', textContent: order.vehicleType || '' }),
            order.number
              ? DOM.el('span', { className: 'text-muted ms-1', textContent: '[' + order.number + ']' })
              : null
          ].filter(Boolean));
        }

        var row = DOM.el('div', { className: 'status-order-row' }, [
          DOM.el('div', {
            className: 'status-indicator',
            style: { backgroundColor: getStatusColor(orderStatus) }
          }),
          DOM.el('div', { className: 'flex-grow-1' }, [
            DOM.el('div', { className: 'd-flex align-items-center gap-2' }, [
              DOM.el('strong', { className: 'small', textContent: order.shipper }),
              DOM.el('span', { className: 'small text-muted', textContent: order.cargoName }),
              DOM.el('span', {
                className: 'badge status-badge-' + getStatusBadgeSuffix(orderStatus),
                style: { fontSize: '0.65rem' },
                textContent: orderStatus
              })
            ]),
            DOM.el('div', { className: 'small text-muted' }, [
              DOM.el('span', {
                textContent: (order.loadDate || '') + ' ' + (order.loadTime || '') + ' ' + loadLoc
              }),
              DOM.el('span', { textContent: ' → ' }),
              DOM.el('span', {
                textContent: (order.unloadDate || '') + ' ' + (order.unloadTime || '') + ' ' + unloadLoc
              })
            ]),
            driverInfo
          ].filter(Boolean)),
          DOM.el('div', { className: 'order-actions' }, actionsChildren)
        ]);

        editBtn.addEventListener('click', function() {
          showEditModal(order);
        });

        if (unassignBtn) {
          unassignBtn.addEventListener('click', function() {
            DataManager.updateOrder(order.requestId, {
              number: '',
              status: STATUS.UNASSIGNED
            }).then(function() {
              UIManager.showToast('割当を解除しました。', 'info');
            }).catch(function(err) {
              UIManager.showToast('割当解除に失敗: ' + err.message, 'danger');
            });
          });
        }

        bodyInner.appendChild(row);
      });

      var collapseDiv = DOM.el('div', {
        className: 'accordion-collapse collapse' + (index === 0 ? ' show' : ''),
        id: collapseId,
        'data-bs-parent': '#statusAccordion'
      }, [bodyInner]);

      var item = DOM.el('div', { className: 'accordion-item' }, [header, collapseDiv]);
      accordion.appendChild(item);
    });
  }

  function showEditModal(order) {
    document.getElementById('editOrderId').value = order.requestId;
    document.getElementById('editShipper').value = order.shipper || '';
    document.getElementById('editCargoName').value = order.cargoName || '';
    document.getElementById('editLoadDate').value = order.loadDate || '';
    document.getElementById('editLoadTime').value = order.loadTime || '';
    document.getElementById('editUnloadDate').value = order.unloadDate || '';
    document.getElementById('editUnloadTime').value = order.unloadTime || '';
    document.getElementById('editStatus').value = order.status || STATUS.UNASSIGNED;

    var vehicleSelect = document.getElementById('editVehicle');
    while (vehicleSelect.options.length > 1) vehicleSelect.remove(1);
    DataManager.getVehicles().forEach(function(v) {
      var opt = new Option(v.number + ' (' + v.vehicleType + ' - ' + v.driverName + ')', v.number);
      vehicleSelect.add(opt);
    });
    vehicleSelect.value = order.number || '';

    var modal = new bootstrap.Modal(document.getElementById('orderEditModal'));
    modal.show();
  }

  function saveEdit() {
    var orderId = document.getElementById('editOrderId').value;
    var updates = {
      loadDate: document.getElementById('editLoadDate').value,
      loadTime: document.getElementById('editLoadTime').value,
      unloadDate: document.getElementById('editUnloadDate').value,
      unloadTime: document.getElementById('editUnloadTime').value,
      number: document.getElementById('editVehicle').value,
      status: document.getElementById('editStatus').value
    };

    DataManager.updateOrder(orderId, updates)
      .then(function() {
        UIManager.showToast('受注を更新しました。', 'success');
        bootstrap.Modal.getInstance(document.getElementById('orderEditModal')).hide();
      })
      .catch(function(err) {
        UIManager.showToast('更新に失敗: ' + err.message, 'danger');
      });
  }

  function unassignFromEdit() {
    var orderId = document.getElementById('editOrderId').value;
    DataManager.updateOrder(orderId, {
      number: '',
      status: STATUS.UNASSIGNED
    }).then(function() {
      UIManager.showToast('割当を解除しました。', 'info');
      bootstrap.Modal.getInstance(document.getElementById('orderEditModal')).hide();
    }).catch(function(err) {
      UIManager.showToast('割当解除に失敗: ' + err.message, 'danger');
    });
  }

  function setup() {
    document.getElementById('statusFilterDate').addEventListener('change', function() {
      filters.date = this.value;
      render();
    });
    document.getElementById('statusFilterStatus').addEventListener('change', function() {
      filters.status = this.value;
      render();
    });
    document.getElementById('statusGroupBy').addEventListener('change', function() {
      filters.groupBy = this.value;
      render();
    });
    document.getElementById('clearStatusFilter').addEventListener('click', function() {
      filters.date = '';
      filters.status = '';
      document.getElementById('statusFilterDate').value = '';
      document.getElementById('statusFilterStatus').value = '';
      render();
    });

    document.getElementById('editSaveBtn').addEventListener('click', saveEdit);
    document.getElementById('editUnassignBtn').addEventListener('click', unassignFromEdit);
  }

  return {
    render: render,
    setup: setup
  };
})();


/* ========================================================
 * ユーティリティ
 * ======================================================== */
function escapeHtml(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}


/* ========================================================
 * アプリ初期化
 * ======================================================== */
document.addEventListener('DOMContentLoaded', function() {
  var overlay = document.getElementById('loadingOverlay');

  DataManager.loadData()
    .then(function() {
      // 初回初期化
      ScheduleManager.setup();
      ScheduleManager.render();
      UIManager.renderUnassignedPool();
      UIManager.setupSidebarFilters();
      UIManager.setupCSVImport();
      StatusManager.setup();

      // Observer登録: データ更新時に全UIを自動更新
      DataManager.subscribe(function() {
        ScheduleManager.render();
        ScheduleManager.populateFilterOptions();
        UIManager.renderUnassignedPool();
        if (document.getElementById('viewStatus').style.display !== 'none') {
          StatusManager.render();
        }
      });

      overlay.style.display = 'none';
    })
    .catch(function(err) {
      DOM.clear(overlay);
      overlay.appendChild(
        DOM.el('div', { className: 'text-center text-danger' }, [
          DOM.el('p', { textContent: 'データの読み込みに失敗しました。' }),
          DOM.el('p', { className: 'small', textContent: err.message }),
          DOM.el('button', {
            className: 'btn btn-primary',
            textContent: '再読み込み'
          })
        ])
      );
      overlay.querySelector('button').addEventListener('click', function() {
        location.reload();
      });
    });

  // タブ切替
  document.querySelectorAll('#mainTabs .nav-link').forEach(function(tab) {
    tab.addEventListener('click', function() {
      document.querySelectorAll('#mainTabs .nav-link').forEach(function(t) {
        t.classList.remove('active');
      });
      this.classList.add('active');

      var view = this.getAttribute('data-view');
      document.getElementById('viewGantt').style.display = view === 'gantt' ? '' : 'none';
      document.getElementById('viewStatus').style.display = view === 'status' ? '' : 'none';

      var navControls = document.getElementById('ganttNavControls');
      if (navControls) navControls.style.display = view === 'gantt' ? '' : 'none';

      if (view === 'status') {
        StatusManager.render();
      }
    });
  });
});
</script>
